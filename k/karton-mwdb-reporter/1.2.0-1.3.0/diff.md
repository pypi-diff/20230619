# Comparing `tmp/karton_mwdb_reporter-1.2.0-py3-none-any.whl.zip` & `tmp/karton_mwdb_reporter-1.3.0-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,14 +1,14 @@
-Zip file size: 8439 bytes, number of entries: 12
--rw-r--r--  2.0 unx      539 b- defN 22-Jul-27 14:19 karton_mwdb_reporter-1.2.0-nspkg.pth
--rw-r--r--  2.0 unx       68 b- defN 22-Jul-27 14:19 karton/mwdb_reporter/__init__.py
--rw-r--r--  2.0 unx       61 b- defN 22-Jul-27 14:19 karton/mwdb_reporter/__main__.py
--rw-r--r--  2.0 unx       22 b- defN 22-Jul-27 14:19 karton/mwdb_reporter/__version__.py
--rw-r--r--  2.0 unx    19469 b- defN 22-Jul-27 14:19 karton/mwdb_reporter/mwdb_reporter.py
--rw-r--r--  2.0 unx     1519 b- defN 22-Jul-27 14:19 karton_mwdb_reporter-1.2.0.dist-info/LICENSE
--rw-r--r--  2.0 unx     1506 b- defN 22-Jul-27 14:19 karton_mwdb_reporter-1.2.0.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 22-Jul-27 14:19 karton_mwdb_reporter-1.2.0.dist-info/WHEEL
--rw-r--r--  2.0 unx       81 b- defN 22-Jul-27 14:19 karton_mwdb_reporter-1.2.0.dist-info/entry_points.txt
--rw-r--r--  2.0 unx        7 b- defN 22-Jul-27 14:19 karton_mwdb_reporter-1.2.0.dist-info/namespace_packages.txt
--rw-r--r--  2.0 unx        7 b- defN 22-Jul-27 14:19 karton_mwdb_reporter-1.2.0.dist-info/top_level.txt
-?rw-rw-r--  2.0 unx     1122 b- defN 22-Jul-27 14:19 karton_mwdb_reporter-1.2.0.dist-info/RECORD
-12 files, 24493 bytes uncompressed, 6489 bytes compressed:  73.5%
+Zip file size: 9523 bytes, number of entries: 12
+-rw-r--r--  2.0 unx      539 b- defN 23-Jun-19 12:20 karton_mwdb_reporter-1.3.0-nspkg.pth
+-rw-r--r--  2.0 unx       68 b- defN 23-Jun-19 12:20 karton/mwdb_reporter/__init__.py
+-rw-r--r--  2.0 unx       61 b- defN 23-Jun-19 12:20 karton/mwdb_reporter/__main__.py
+-rw-r--r--  2.0 unx       22 b- defN 23-Jun-19 12:20 karton/mwdb_reporter/__version__.py
+-rw-r--r--  2.0 unx    22832 b- defN 23-Jun-19 12:20 karton/mwdb_reporter/mwdb_reporter.py
+-rw-r--r--  2.0 unx     1519 b- defN 23-Jun-19 12:20 karton_mwdb_reporter-1.3.0.dist-info/LICENSE
+-rw-r--r--  2.0 unx     2122 b- defN 23-Jun-19 12:20 karton_mwdb_reporter-1.3.0.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 23-Jun-19 12:20 karton_mwdb_reporter-1.3.0.dist-info/WHEEL
+-rw-r--r--  2.0 unx       81 b- defN 23-Jun-19 12:20 karton_mwdb_reporter-1.3.0.dist-info/entry_points.txt
+-rw-r--r--  2.0 unx        7 b- defN 23-Jun-19 12:20 karton_mwdb_reporter-1.3.0.dist-info/namespace_packages.txt
+-rw-r--r--  2.0 unx        7 b- defN 23-Jun-19 12:20 karton_mwdb_reporter-1.3.0.dist-info/top_level.txt
+?rw-rw-r--  2.0 unx     1122 b- defN 23-Jun-19 12:20 karton_mwdb_reporter-1.3.0.dist-info/RECORD
+12 files, 28472 bytes uncompressed, 7573 bytes compressed:  73.4%
```

## zipnote {}

```diff
@@ -1,37 +1,37 @@
-Filename: karton_mwdb_reporter-1.2.0-nspkg.pth
+Filename: karton_mwdb_reporter-1.3.0-nspkg.pth
 Comment: 
 
 Filename: karton/mwdb_reporter/__init__.py
 Comment: 
 
 Filename: karton/mwdb_reporter/__main__.py
 Comment: 
 
 Filename: karton/mwdb_reporter/__version__.py
 Comment: 
 
 Filename: karton/mwdb_reporter/mwdb_reporter.py
 Comment: 
 
-Filename: karton_mwdb_reporter-1.2.0.dist-info/LICENSE
+Filename: karton_mwdb_reporter-1.3.0.dist-info/LICENSE
 Comment: 
 
-Filename: karton_mwdb_reporter-1.2.0.dist-info/METADATA
+Filename: karton_mwdb_reporter-1.3.0.dist-info/METADATA
 Comment: 
 
-Filename: karton_mwdb_reporter-1.2.0.dist-info/WHEEL
+Filename: karton_mwdb_reporter-1.3.0.dist-info/WHEEL
 Comment: 
 
-Filename: karton_mwdb_reporter-1.2.0.dist-info/entry_points.txt
+Filename: karton_mwdb_reporter-1.3.0.dist-info/entry_points.txt
 Comment: 
 
-Filename: karton_mwdb_reporter-1.2.0.dist-info/namespace_packages.txt
+Filename: karton_mwdb_reporter-1.3.0.dist-info/namespace_packages.txt
 Comment: 
 
-Filename: karton_mwdb_reporter-1.2.0.dist-info/top_level.txt
+Filename: karton_mwdb_reporter-1.3.0.dist-info/top_level.txt
 Comment: 
 
-Filename: karton_mwdb_reporter-1.2.0.dist-info/RECORD
+Filename: karton_mwdb_reporter-1.3.0.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## karton/mwdb_reporter/__version__.py

```diff
@@ -1 +1 @@
-__version__ = "1.2.0"
+__version__ = "1.3.0"
```

## karton/mwdb_reporter/mwdb_reporter.py

```diff
@@ -1,26 +1,29 @@
+import argparse
+import hashlib
 from typing import Any, Callable, Dict, List, Optional, Tuple, cast
 
-from karton.core import Karton, RemoteResource, Task
-from mwdblib import MWDB, MWDBBlob, MWDBConfig, MWDBFile, MWDBObject
+from karton.core import Config, Karton, RemoteResource, Task
+from mwdblib import MWDB, MWDBBlob, MWDBConfig, MWDBFile, MWDBObject, config_dhash
 from mwdblib.api.options import APIClientOptions
+from mwdblib.exc import ObjectTooLargeError
 
 from .__version__ import __version__
 
 
 class MWDBReporter(Karton):
     """
     Uploads analysis artifacts to MWDB.
 
     Expected incoming task structure for samples:
     ```
     {
         "headers": {
             "type": "sample",
-            "stage": "recognized" (to be processed) or "analyzed" (final artifact)
+            "stage": "recognized" (to be processed), "analyzed" (final artifact) or "unrecognized" (unknown file)
             "kind": all but not "raw", must have known type or be checked first by "karton.classifier"
             "platform": optional target platform
             "extension": optional file type extension
         },
         "payload": {
             "sample": Resource with sample contents
             "parent": optional, Resource with parent sample contents
@@ -35,15 +38,16 @@
     Samples are decorated with tag: ``kind:platform:extension`` or ``misc:kind`` if platform is missing
 
     Expected incoming task structure for configs:
     ```
     {
         "headers": {
             "type": "config",
-            "family": <malware family>
+            "family": <malware family>,
+            "config_type": <config type> ("static" by default)
         },
         "payload": {
             "sample": Resource with **original** sample contents
                       or identifier (hash) of object
             "parent": optional, Resource with **unpacked** sample/dump contents
                       or identifier (hash) of object
             "tags": optional, list of additional tags to be added
@@ -74,18 +78,18 @@
     """  # noqa
 
     identity = "karton.mwdb-reporter"
     version = __version__
     filters = [
         {"type": "sample", "stage": "recognized"},
         {"type": "sample", "stage": "analyzed"},
+        {"type": "sample", "stage": "unrecognized"},
         {"type": "config"},
         {"type": "blob"},
     ]
-    MAX_FILE_SIZE = 1024 * 1024 * 40
 
     def _get_mwdb(self) -> MWDB:
         mwdb_config = self.config["mwdb"]
         mwdb = MWDB(
             api_key=mwdb_config.get("api_key"),
             api_url=mwdb_config.get("api_url", APIClientOptions.api_url),
             username=mwdb_config.get("username"),
@@ -96,14 +100,18 @@
         )
         return mwdb
 
     def __init__(self, *args, **kwargs) -> None:
         super().__init__(*args, **kwargs)
         self.mwdb = self._get_mwdb()
 
+        self.report_unrecognized = self.config.getboolean(
+            "mwdb-reporter", "report_unrecognized", fallback=False
+        )
+
     def _add_tags(self, mwdb_object: MWDBObject, tags: List[str]) -> None:
         # Upload tags and attributes via subsequent requests
         for tag in tags:
             if tag not in mwdb_object.tags:
                 self.log.info(
                     "[%s %s] Adding tag %s", mwdb_object.TYPE, mwdb_object.id, tag
                 )
@@ -117,17 +125,14 @@
                 )
 
     def _add_attributes(
         self, mwdb_object: MWDBObject, attributes: Dict[str, List[Any]]
     ) -> None:
         # Add attributes
         for key, values in attributes.items():
-            if key == "karton":
-                # Omitting karton attribute
-                continue
             for value in values:
                 if (
                     key not in mwdb_object.attributes
                     or value not in mwdb_object.attributes[key]
                 ):
                     self.log.info(
                         "[%s %s] Adding attribute %s: %s",
@@ -211,14 +216,17 @@
         if object_getter:
             existing_object = object_getter()
         else:
             existing_object = None
 
         metadata: List[str] = []
 
+        # Filter out 'karton' attribute which should not be reuploaded
+        attributes = {k: v for k, v in attributes.items() if k != "karton"}
+
         if not existing_object:
             if self.mwdb.api.supports_version("2.6.0"):
                 mwdb_object = object_uploader(
                     **object_params,
                     parent=parent,
                     tags=tags,
                     attributes=attributes,
@@ -278,15 +286,15 @@
         self,
         task: Task,
         resource: RemoteResource,
         parent: Optional[MWDBObject] = None,
         tags: Optional[List[str]] = None,
         attributes: Optional[Dict[str, List[Any]]] = None,
         comments: Optional[List[str]] = None,
-    ) -> Tuple[bool, MWDBObject]:
+    ) -> Optional[Tuple[bool, MWDBObject]]:
         """
         Upload file to MWDB or get from repository if already exists
         ensuring that all provided metadata are set
 
         :param task: Related task
         :param resource: Resource with file contents
         :param parent: Parent object that needs to be attached to object
@@ -304,24 +312,30 @@
         if parent and parent.id == file_id:
             parent = None
 
         def file_getter():
             self.log.info("[%s %s] Querying for object", MWDBFile.TYPE, file_id)
             return self.mwdb.query_file(file_id, raise_not_found=False)
 
-        return self._upload_object(
-            object_getter=file_getter,
-            object_uploader=self.mwdb.upload_file,
-            object_params=dict(name=resource.name, content=resource.content),
-            parent=parent,
-            tags=tags,
-            attributes=attributes,
-            comments=comments,
-            karton_id=task.root_uid,
-        )
+        try:
+            uploaded_object = self._upload_object(
+                object_getter=file_getter,
+                object_uploader=self.mwdb.upload_file,
+                object_params=dict(name=resource.name, content=resource.content),
+                parent=parent,
+                tags=tags,
+                attributes=attributes,
+                comments=comments,
+                karton_id=task.root_uid,
+            )
+        except ObjectTooLargeError:
+            self.log.warning("[%s %s] Too large to upload", MWDBFile.TYPE, file_id)
+            return None
+
+        return uploaded_object
 
     def _upload_config(
         self,
         task: Task,
         family: str,
         config_type: str,
         config: Dict[str, Any],
@@ -339,16 +353,22 @@
         :param config: Configuration contents
         :param parent: Parent object that needs to be attached to object
         :param tags: List of tags to add
         :param attributes: Set of attributes to add
         :param comments: List of comments to add
         :return: Tuple (is new, uploaded object)
         """
+        config_id = config_dhash(config)
+
+        def config_getter():
+            self.log.info("[%s %s] Querying for object", MWDBConfig.TYPE, config_id)
+            return self.mwdb.query_config(config_id, raise_not_found=False)
+
         return self._upload_object(
-            object_getter=None,
+            object_getter=config_getter,
             object_uploader=self.mwdb.upload_config,
             object_params=dict(
                 family=family,
                 cfg=config,
                 config_type=config_type,
             ),
             parent=parent,
@@ -378,16 +398,22 @@
         :param content: Blob content
         :param parent: Parent object that needs to be attached to object
         :param tags: List of tags to add
         :param attributes: Set of attributes to add
         :param comments: List of comments to add
         :return: Tuple (is new, uploaded object)
         """
+        blob_id = hashlib.sha256(content.encode("utf-8")).hexdigest()
+
+        def blob_getter():
+            self.log.info("[%s %s] Querying for object", MWDBBlob.TYPE, blob_id)
+            return self.mwdb.query_blob(blob_id, raise_not_found=False)
+
         return self._upload_object(
-            object_getter=None,
+            object_getter=blob_getter,
             object_uploader=self.mwdb.upload_blob,
             object_params=dict(
                 name=blob_name,
                 type=blob_type,
                 content=content,
             ),
             parent=parent,
@@ -412,38 +438,58 @@
                 )
                 item.add_tag(tag)
 
     def process_sample(self, task: Task) -> None:
         parent_payload = task.get_payload("parent")
         parent: Optional[MWDBObject]
 
+        if task.headers.get("stage") == "unrecognized" and not self.report_unrecognized:
+            self.log.info(
+                (
+                    "Sample is unrecognized and reporter is not configured "
+                    "to report them, dropping the task"
+                )
+            )
+            return
+
         if isinstance(parent_payload, RemoteResource):
             # Upload parent file
-            _, parent = self._upload_file(
+            uploaded = self._upload_file(
                 task,
                 task.get_payload("parent"),
             )
+            if uploaded:
+                _, parent = uploaded
+            else:
+                self.log.warning(
+                    "Failed to upload parent sample, linking to root instead"
+                )
+                parent = None
         elif isinstance(parent_payload, str):
             # Query parent object hash
             parent = self.mwdb.query(parent_payload, raise_not_found=False)
         else:
             parent = None
 
-        self._upload_file(
+        uploaded = self._upload_file(
             task,
             task.get_payload("sample"),
             parent=parent,
             tags=task.get_payload("tags", []),
             attributes=task.get_payload("attributes", {}),
             comments=task.get_payload("comments", [])
             or task.get_payload("additional_info", []),
         )
+        if uploaded is None:
+            self.log.warning("Failed to upload sample")
 
     def process_config(self, task: Task) -> None:
         config_data = task.get_payload("config")
+        warning_comments = []
+
         family = (
             task.headers["family"]
             or config_data.get("family")
             or config_data.get("type", "unknown")
         )
         config_type = task.headers.get("config_type", "static")
 
@@ -453,31 +499,47 @@
             )
 
         # Upload original sample
         sample: Optional[MWDBObject] = None
         sample_payload = task.get_payload("sample")
         if isinstance(sample_payload, RemoteResource):
             # Upload original sample file
-            _, sample = self._upload_file(
+            uploaded = self._upload_file(
                 task, task.get_payload("sample"), tags=["ripped:" + family]
             )
+            if uploaded:
+                _, sample = uploaded
+            else:
+                self.log.warning("Failed to upload sample for config")
+
         elif isinstance(sample_payload, str):
             # Query original sample object hash
             sample = self.mwdb.query_file(sample_payload, raise_not_found=False)
             if sample:
                 self._add_tags(sample, ["ripped:" + family])
 
         # Upload dump that contains recognized config information
         parent: Optional[MWDBObject] = None
         parent_payload = task.get_payload("parent")
         if isinstance(parent_payload, RemoteResource):
             # Upload parent file
-            _, parent = self._upload_file(
+            uploaded = self._upload_file(
                 task, task.get_payload("parent"), parent=sample, tags=[family]
             )
+            if uploaded:
+                _, parent = uploaded
+            else:
+                self.log.warning("Failed to upload parent for config")
+                warning_comments.append(
+                    "warning: mwdb-reporter failed to upload the source memory dump "
+                    "and the config is linked to the closest possible relative"
+                )
+                # link the config to grandparent if we couldn't upload the parent
+                if sample is not None:
+                    parent = sample
         elif isinstance(parent_payload, str):
             # Query parent object hash
             parent = self.mwdb.query(parent_payload, raise_not_found=False)
             if parent:
                 self._add_parent(parent, parent=sample)
                 self._add_tags(parent, [family])
 
@@ -485,29 +547,37 @@
             task,
             family,
             config_type,
             config_data,
             parent=parent,
             tags=task.get_payload("tags", []),
             attributes=task.get_payload("attributes", {}),
-            comments=task.get_payload("comments", [])
-            or task.get_payload("additional_info", []),
+            comments=(
+                task.get_payload("comments", [])
+                or task.get_payload("additional_info", [])
+            )
+            + warning_comments,
         )
         if not is_new:
             self._tag_children_blobs(cast(MWDBConfig, config))
 
     def process_blob(self, task: Task) -> None:
         parent_payload = task.get_payload("parent")
         parent: Optional[MWDBObject] = None
         if isinstance(parent_payload, RemoteResource):
             # Upload parent file
-            _, parent = self._upload_file(
+            uploaded = self._upload_file(
                 task,
                 task.get_payload("parent"),
             )
+            if uploaded is None:
+                self.log.warning("Failed to upload blob parent")
+                parent = None
+            else:
+                _, parent = uploaded
         elif isinstance(parent_payload, str):
             # Query parent object hash
             parent = self.mwdb.query(parent_payload, raise_not_found=False)
 
         self._upload_blob(
             task,
             blob_name=task.get_payload("name", default="blob"),
@@ -518,17 +588,36 @@
             attributes=task.get_payload("attributes", {}),
             comments=task.get_payload("comments", [])
             or task.get_payload("additional_info", []),
         )
 
     def process(self, task: Task) -> None:
         object_type = task.headers["type"]
-        mwdb_object: Optional[MWDBObject]
 
         if object_type == "sample":
             self.process_sample(task)
         elif object_type == "config":
             self.process_config(task)
         elif object_type == "blob":
             self.process_blob(task)
         else:
             raise RuntimeError("Unsupported object type")
+
+    @classmethod
+    def args_parser(cls) -> argparse.ArgumentParser:
+        parser = super().args_parser()
+        parser.add_argument(
+            "--report-unrecognized",
+            action="store_true",
+            default=None,
+            help="Upload files unrecognized by classifier (false by default)",
+        )
+        return parser
+
+    @classmethod
+    def config_from_args(cls, config: Config, args: argparse.Namespace) -> None:
+        super().config_from_args(config, args)
+        config.load_from_dict(
+            {
+                "mwdb-reporter": {"report_unrecognized": args.report_unrecognized},
+            }
+        )
```

## Comparing `karton_mwdb_reporter-1.2.0-nspkg.pth` & `karton_mwdb_reporter-1.3.0-nspkg.pth`

 * *Files identical despite different names*

## Comparing `karton_mwdb_reporter-1.2.0.dist-info/LICENSE` & `karton_mwdb_reporter-1.3.0.dist-info/LICENSE`

 * *Files identical despite different names*

## Comparing `karton_mwdb_reporter-1.2.0.dist-info/METADATA` & `karton_mwdb_reporter-1.3.0.dist-info/METADATA`

 * *Files 12% similar despite different names*

```diff
@@ -1,33 +1,34 @@
 Metadata-Version: 2.1
 Name: karton-mwdb-reporter
-Version: 1.2.0
+Version: 1.3.0
 Summary: Karton service that uploads analyzed artifacts and metadata to MWDB Core
 Home-page: https://github.com/CERT-Polska/karton-mwdb-reporter/
 License: UNKNOWN
 Platform: UNKNOWN
 Classifier: Programming Language :: Python
 Classifier: Operating System :: OS Independent
 Description-Content-Type: text/markdown
+License-File: LICENSE
 Requires-Dist: karton-core (<6.0.0,>=5.0.0)
-Requires-Dist: mwdblib (>=4.1.0)
+Requires-Dist: mwdblib (>=4.3.0)
 
 # Reporter karton service
 
 Uploads samples and static configs to malwaredb
 
 **Author**: CERT.pl
 
 **Maintainers**: psrok1, nazywam
 
 **Consumes:**
 ```
 {
     "type": "sample",
-    "stage": "recognized" || "analyzed"
+    "stage": "recognized" || "analyzed" || "unrecognized"
 },
 {
     "type": "config"
 },
 {
     "type": "blob"
 }
@@ -58,9 +59,25 @@
 
 ```shell
 $ pip install karton-mwdb-reporter
 
 $ karton-mwdb-reporter
 ```
 
+
+## Configuration
+
+Using the `--report-unrecognized` flag you specify whether the reporter should upload files unrecognized by the classifier. You can also configure this using the built-in configuration backend by either adjusting it in the karton.ini
+
+```ini
+[mwdb-reporter]
+report_unrecognized=true
+```
+
+or setting the environmental variable like so `KARTON_MWDB-REPORTER_REPORT_UNRECOGNIZED=true`.
+
+To learn more about configuring your karton services, take a look at [karton configuration docs](https://karton-core.readthedocs.io/en/latest/service_configuration.html)
+
+
 ![Co-financed by the Connecting Europe Facility by of the European Union](https://www.cert.pl/uploads/2019/02/en_horizontal_cef_logo-e1550495232540.png)
 
+
```

